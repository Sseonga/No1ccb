import React, { useEffect, useRef, useState } from "react";
import {
  BrowserRouter,
  Route,
  Routes,
  Navigate,
  useLocation,
} from "react-router-dom";
import "@fortawesome/fontawesome-free/css/all.min.css";
import "./App.css";

// Í¥ÄÎ¶¨Ïûê Ïª¥Ìè¨ÎÑåÌä∏
import AdminLayout from "./components/admin/AdminLayout";
import ReportReviewTable from "./components/admin/ReportReviewTable";
import AccommodationAddForm from "./components/accommodation/AccommodationAddForm";
import UserManageTable from "./components/admin/UserManageTable";
import ChargePayCalc from "./components/calc/ChargePayCalc";
// ÏÇ¨Ïö©Ïûê Ïª¥Ìè¨ÎÑåÌä∏
import Tmap from "./components/station/Tmap";
import Sidebar from "./components/common/Sidebar";
import MyLocationButton from "./components/common/MyLocationButton";
import FilterPanel from "./components/station/Filterpanel";
import RouteSearchPanel from "./components/route/RouteSearchPanel";
import IntroCar from "./components/intro/IntroCar";
import LoginPanel from "./components/user/LoginPanel";

// ÎßàÏù¥ÌéòÏù¥ÏßÄ Ïª¥Ìè¨ÎÑåÌä∏
import FavoriteListPanel from "./components/user/FavoriteListPanel"; // ÎßàÏù¥ÌéòÏù¥ÏßÄ Î†àÏù¥ÏïÑÏõÉ
import PasswordChangeForm from "./components/user/PasswordChangeForm";

import MyPageLayout from "./components/user/MyPageLayout";
import StationListPanel from "./components/station/StationListPanel";
import SearchAgainButton from "./components/common/SearchAgainButton";
import StationDetailPanel from "./components/station/StationDetailPanel";
import SpotListPanel from "./components/station/SpotListPanel";
import MyStationPanel from "./components/user/MyStationPanel";
import AccomMap from "./components/accommodation/AccomMap";
import AccommodationPanel from "./components/accommodation/AccommodationPanel";

// Í¥ÄÎ¶¨Ïûê Ïó¨Î∂Ä ÌôïÏù∏
const isAdmin = sessionStorage.getItem("isAdmin") === "Y";

// ÏÇ¨Ïö©ÏûêÏö© Î†àÏù¥ÏïÑÏõÉ
const UserLayout = () => {
  //DB ÏΩîÎìúÌÖåÏù¥Î∏î Ïó∞Îèô ÌïÑÌÑ∞ Îßµ
  const [chargerTypeMap, setChargerTypeMap] = useState({});
  const [operatorMap, setOperatorMap] = useState({});

  useEffect(() => {
    fetch("/api/code/map")
      .then((res) => res.json())
      .then((data) => {
        setChargerTypeMap(data.CHARGER_TYPE || {});
        setOperatorMap(data.OPERATOR || {});
      })
      .catch((err) => console.error("Í≥µÌÜµÏΩîÎìú Î°úÎî© Ïã§Ìå®", err));
  }, []);

  const [filters, setFilters] = useState({
    type: [],
    parking: [],
    operator: [],
  });
  const myMarkerRef = useRef(null);
  const location = useLocation();
  const handleResetMarkers = useRef(null);
  //Ìôà(Ï†ÑÍ∏∞Ï∞®Ï∂©Ï†ÑÏÜå Ï∞æÍ∏∞ Îßµ)
  const isHome = location.pathname === "/";
  const [poiList, setPoiList] = useState([]);
  const [filteredPoiList, setFilteredPoiList] = useState([]);
  const [selectedPoi, setSelectedPoi] = useState(null); // Ï∂©Ï†ÑÏÜå ÏÑ†ÌÉùÎê®
  const [showSpotList, setShowSpotList] = useState(false); // Ï£ºÎ≥Ä Ìé∏ÏùòÏãúÏÑ§ Î≥¥Í∏∞ Î™®Îìú
  const [center, setCenter] = useState({});
  const [loading, setLoading] = useState(false);
  const [errorMsg, setErrorMsg] = useState("");

  const mapRef = useRef(null); // Tmap Map Í∞ùÏ≤¥ Î≥¥Í¥ÄÏö©
  const [isMapMoved, setIsMapMoved] = useState(false);

  //ÌòÑÏû¨ ÏúÑÏπò Î∞õÏùÑÏàòÏûàÏúºÎ©¥ ÌòÑÏû¨ÏúÑÏπòÎ°ú ÏßÄÎèÑÏÑºÌÑ∞ ÏÑ§Ï†ï
  useEffect(() => {
    if (!navigator.geolocation) return;

    navigator.geolocation.getCurrentPosition(
      (pos) => {
        const { latitude, longitude } = pos.coords;
        setCenter({ lat: latitude, lon: longitude }); // Ï§ëÏã¨ Ï¢åÌëú ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
      },
      (err) => {
        console.warn("ÌòÑÏû¨ÏúÑÏπò Ï°∞Ìöå Ïã§Ìå®, Í∏∞Î≥∏Í∞í ÏÇ¨Ïö©", err);
        setCenter({ lat: 36.81023, lon: 127.14644 }); // Ï≤úÏïàÏó≠
      }
    );
  }, []);

  //centerÍ∞í Î≥ÄÍ≤ΩÏãú centerÍ∏∞Ï§ÄÏúºÎ°ú poiÏû¨Í≤ÄÏÉâÌõÑ poilistÏû¨ÏÑ§Ï†ï
  useEffect(() => {
    const fetchPOIs = async () => {
      if (!center.lat || !center.lon) return;
      setLoading(true);
      try {
        const res = await fetch(
          `https://apis.openapi.sk.com/tmap/pois?version=1&searchKeyword=Ï†ÑÍ∏∞Ï∞® Ï∂©Ï†ÑÏÜå&centerLat=${center.lat}&centerLon=${center.lon}&radius=5&count=20&resCoordType=WGS84GEO&reqCoordType=WGS84GEO&appKey=WGS84GEO&reqCoordType=WGS84GEO&appKey=YgInMIl2n421NwwwG3XOrf0oQSE1paEFRCFbejc0`
        );
        const data = await res.json();
        // setPoiList(data?.searchPoiInfo?.pois?.poi ?? []);
        const pois = data?.searchPoiInfo?.pois?.poi ?? [];

        // poi.id + frontLat/frontLonÎßå Ï∂îÏ∂ú
        const trimmedPOIs = pois.map((poi) => ({
          id: poi.pkey,
          lat: parseFloat(poi.frontLat),
          lng: parseFloat(poi.frontLon),
        }));

        // Î∞±ÏóîÎìúÏóêÏÑú parkingId, parkingFeeÎ•º Îã¨ÏïÑÏÑú ÎèåÎ†§Ï£ºÎäî ÏöîÏ≤≠
        const parkingRes = await fetch("/api/charger/match-parking", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(trimmedPOIs),
        });

        if (!res.ok) {
          const text = await res.text();
          throw new Error(`API ÏóêÎü¨: ${res.status} - ${text}`);
        }

        const matched = await parkingRes.json(); // { poiId, parkingId }[]

        // ÏõêÎ≥∏ poisÏóê parkingIdÎ•º Îß§ÌïëÌï¥ÏÑú ÏÉà Î¶¨Ïä§Ìä∏ ÏÉùÏÑ±
        const parkingPois = pois.map((poi) => {
          const match = matched.find((m) => m.poiId === poi.pkey);
          return {
            ...poi,
            parkingId: match?.parkingId ?? null,
            parkingFee: match?.parkingFee ?? null,
          };
        });
        console.log(parkingPois);

        setPoiList(parkingPois);
      } catch (e) {
        console.error(e);
        setErrorMsg("API ÏóêÎü¨ Î∞úÏÉù");
      }
      setLoading(false);
    };
    fetchPOIs();
  }, [center]);

  useEffect(() => {
    const applyFilters = () => {
      const filtered = poiList.filter((poi) => {
        const chargers = poi.evChargers?.evCharger ?? [];
        console.log(filters);
        console.log(chargers);

        // üîå Ï∂©Ï†Ñ ÌÉÄÏûÖ ÌïÑÌÑ∞
        if (filters.type.length > 0) {
          const hasMatchingCharger = chargers.some((ch) => {
            return filters.type.includes(ch.type); // Ïòà: "CHARGER_TYPE_01"
          });
          if (!hasMatchingCharger) return false;
        }

        // üÖøÔ∏è Ï£ºÏ∞® ÌïÑÌÑ∞
        if (
          filters.parking.length > 0 &&
          !filters.parking.includes(poi.parkingFee)
        ) {
          return false;
        }

        // ‚ö°Ô∏è Ïö¥ÏòÅÏÇ¨ ÌïÑÌÑ∞
        if (filters.operator.length > 0) {
          const hasMatchingOperator = chargers.some((ch) =>
            filters.operator.includes(ch.operatorId)
          );
          if (!hasMatchingOperator) return false;
        }

        return true;
      });

      setFilteredPoiList(filtered);
    };

    applyFilters();
  }, [filters, poiList]);

  const hideOn = [
    "/info",
    "/user",
    "/user/*",
    "/mypage/info",
    "/mypage/favorites",
    "/mypage/reviews",
    "/calc",
    "/route",
    "/hotel"
  ];
  const hideUI = hideOn.includes(location.pathname);

  return (
    <div className="container">
      <Sidebar />
      {!hideUI && isHome && poiList.length > 0 && !selectedPoi && (
        <StationListPanel
          poiList={filteredPoiList}
          selectedPoi={selectedPoi}
          onSelectPoi={(poi) => {
            if (poi === null && handleResetMarkers.current) {
              handleResetMarkers.current(); // ‚úÖ ÎßàÏª§ Îã§Ïãú Î≥¥Ïù¥Í∏∞
            }
            setSelectedPoi(poi);
          }}
        />
      )}
      {/* {selectedPoi && (
        <div className="station-list-panel">
          <button className="back-button" onClick={() => {
            setSelectedPoi(null)
            handleResetMarkers.current();
            }}>‚Üê Î™©Î°ùÏúºÎ°ú</button>
          <StationDetailPanel poi={selectedPoi} />
        </div>
      )} */}
      {selectedPoi &&
        (showSpotList ? (
          <SpotListPanel
            center={{ lat: selectedPoi.frontLat, lon: selectedPoi.frontLon }}
            onClose={() => setShowSpotList(false)}
            onBackToStation={() => setShowSpotList(false)}
          />
        ) : (
          <div className="station-list-panel">
            <button
              className="back-button"
              onClick={() => {
                setSelectedPoi(null);
                handleResetMarkers.current();
              }}
            >
              ‚Üê Î™©Î°ùÏúºÎ°ú
            </button>
            <StationDetailPanel
              poi={selectedPoi}
              onShowSpots={() => setShowSpotList(true)} // Ï£ºÎ≥Ä Ìé∏ÏùòÏãúÏÑ§ Î≤ÑÌäºÏö©
            />
          </div>
        ))}

      <Routes>
        <Route
          path="/"
          element={
            <Tmap
              poiList={filteredPoiList}
              onMarkerClick={setSelectedPoi}
              mapRef={mapRef}
              myMarkerRef={myMarkerRef}
              onMapMoved={() => setIsMapMoved(true)}
              hideUI={hideUI}
              mapMoved={isMapMoved}
              onResetMarkers={(fn) => (handleResetMarkers.current = fn)}
              selectedPoi={selectedPoi}
            />
          }
        />

       <Route path="/hotel" element={<AccommodationPanel />} />
      </Routes>

      {isHome && (
        <>
          <MyLocationButton tmapObjRef={mapRef} myMarkerRef={myMarkerRef} />
          {isMapMoved && (
            <SearchAgainButton
              onClick={() => {
                const center = mapRef.current.getCenter();
                setCenter({ lat: center._lat, lon: center._lng });
                setIsMapMoved(false);
              }}
            />
          )}

          <FilterPanel
            filters={filters}
            onChange={setFilters}
            poiList={poiList}
            chargerTypeMap={chargerTypeMap}
            operatorMap={operatorMap}
          />
        </>
      )}

      <Routes>
        <Route path="/" element={<></>} />
        <Route path="/route" element={<RouteSearchPanel />} />
        <Route path="/hotel" element={<AccommodationPanel />} />
        <Route path="/calc" element={<ChargePayCalc />} />
        <Route path="/info" element={<IntroCar />} />
        <Route path="/user/*" element={<LoginPanel />} />

        {/* ‚úÖ ÎßàÏù¥ÌéòÏù¥ÏßÄ Î™®Îã¨ ÎùºÏö∞ÌåÖ */}
        <Route path="/mypage" element={<MyPageLayout />}>
          <Route path="info" element={<PasswordChangeForm />} />
          <Route path="favorites" element={<FavoriteListPanel />} />
          <Route path="stations" element={<MyStationPanel  />} />

          <Route index element={<Navigate to="info" replace />} />
        </Route>
      </Routes>
    </div>
  );
};

// App Ïª¥Ìè¨ÎÑåÌä∏
const App = () => {
  return (
    <BrowserRouter>
      <Routes>
        {/* Í¥ÄÎ¶¨Ïûê ÎùºÏö∞ÌåÖ */}
        {isAdmin ? (
          <Route path="/admin" element={<AdminLayout />}>
            <Route
              path="/admin/accommodation"
              element={<AccommodationAddForm />}
            />
            <Route path="/admin/report" element={<ReportReviewTable />} />
            <Route path="/admin/userCare" element={<UserManageTable />} />
          </Route>
        ) : (
          <>
            {/* Í¥ÄÎ¶¨Ïûê Ï†ëÍ∑º Ï∞®Îã® ‚Üí ÌôàÏúºÎ°ú Î¶¨Îã§Ïù¥Î†âÌä∏ */}
            <Route path="/admin/*" element={<Navigate to="/" replace />} />
          </>
        )}

        {/* ÏÇ¨Ïö©Ïûê Í∏∞Î≥∏ Î†àÏù¥ÏïÑÏõÉ */}
        <Route path="/*" element={<UserLayout />} />
      </Routes>
    </BrowserRouter>
  );
};

export default App;