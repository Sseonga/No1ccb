<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="fs.human.ecospot.personal.dao.RecentDAO">

    <!-- (1) 최근 검색 기록 추가 (INSERT) -->
    <insert id="insertRecent" parameterType="fs.human.ecospot.personal.vo.RecentVO">
        INSERT INTO TB_RECENT (
        recent_id, user_id, recent_type_cd,
        start_address, start_address_d, start_lat, start_lon,
        end_address, end_address_d, end_lat, end_lon, keyword,
        created_date, created_id, updated_date, updated_id
        ) VALUES (
        TB_RECENT_SEQ.NEXTVAL, #{userId}, #{recentTypeCd},
        #{startAddress}, #{startAddressD, jdbcType=VARCHAR}, #{startLat}, #{startLon},
        #{endAddress}, #{endAddressD, jdbcType=VARCHAR}, #{endLat}, #{endLon}, #{keyword, jdbcType=VARCHAR},
        SYSDATE, #{userId}, SYSDATE, #{userId}
        )
    </insert>

    <!-- (2) 유저별 최근 검색 목록 조회 (최신 10개) -->
    <select id="selectRecentByUser" resultType="fs.human.ecospot.personal.vo.RecentVO">
        SELECT *
        FROM TB_RECENT
        WHERE user_id = #{userId}
        ORDER BY created_date DESC
        FETCH FIRST 10 ROWS ONLY
    </select>

    <!-- (3) 중복 경로/타입 체크 (출발/도착/타입/유저) -->
    <select id="selectRecentDup" parameterType="fs.human.ecospot.personal.vo.RecentVO" resultType="com.project3.backend.recent.vo.RecentVO">
        SELECT *
        FROM TB_RECENT
        WHERE user_id = #{userId}
        AND start_address = #{startAddress}
        AND end_address = #{endAddress}
        AND recent_type_cd = #{recentTypeCd}
        ORDER BY created_date DESC
        FETCH FIRST 1 ROWS ONLY
    </select>

    <!-- (4) 유저별, 타입별 가장 오래된 최근검색 1개 삭제 (10개 제한용) -->
    <delete id="deleteOldestRecent">
        DELETE FROM TB_RECENT
        WHERE recent_id = (
        SELECT recent_id FROM (
        SELECT recent_id
        FROM TB_RECENT
        WHERE user_id = #{userId}
        AND recent_type_cd = #{recentTypeCd}
        ORDER BY created_date ASC
        FETCH FIRST 1 ROWS ONLY
        )
        )
    </delete>

    <!-- (5) 동일 유저+출발+도착+타입의 기존 경로 삭제 (중복 제거) -->
    <delete id="deleteRecentDup" parameterType="fs.human.ecospot.personal.vo.RecentVO">
        DELETE FROM TB_RECENT
        WHERE user_id = #{userId}
        AND start_address = #{startAddress}
        AND end_address = #{endAddress}
        AND recent_type_cd = #{recentTypeCd}
    </delete>

</mapper>
