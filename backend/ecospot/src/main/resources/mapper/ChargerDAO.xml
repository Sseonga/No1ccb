<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="fs.human.ecospot.charger.dao.ChargerDAO">
    <select id="selectAllCharger" resultType="fs.human.ecospot.charger.vo.ChargerVO">
        SELECT
        PARKING_ID AS parkingId,
        PARKING_NAME AS parkingName,
        PARKING_LON AS parkingLon,
        PARKING_LAT AS parkingLat,
        PARKING_FEE AS parkingFee,
        PARKING_CODE AS parkingCode,
        PARKING_ADDRESS AS parkingAddress,
        PARKING_ADDRESS_D AS parkingAddressD
        FROM PARKING_TABLE
    </select>

    <resultMap id="ParkingResultMap" type="fs.human.ecospot.charger.dto.PoiParkingMatchDTO">
        <result property="parkingId" column="parking_id" />
        <result property="parkingFee" column="parking_fee" />
    </resultMap>

    <select id="findNearestParkingInfo" resultMap="ParkingResultMap">
        SELECT parking_id, parking_fee FROM (
        SELECT parking_id, parking_fee, (
        6371000 * acos(
        cos(radians(#{lat})) * cos(radians(parking_lat)) *
        cos(radians(parking_lon) - radians(#{lng})) +
        sin(radians(#{lat})) * sin(radians(parking_lat))
        )
        ) AS distance
        FROM TB_PARKING
        WHERE parking_lat BETWEEN #{lat} - 0.001 AND #{lat} + 0.001
        AND parking_lon BETWEEN #{lng} - 0.001 AND #{lng} + 0.001
        )
        WHERE distance &lt;= 100
        ORDER BY distance
        FETCH FIRST 1 ROWS ONLY
    </select>

    <!-- 충전소 존재 여부 확인 -->
    <select id="existsStation" resultType="boolean" parameterType="long">
        SELECT CASE WHEN EXISTS (
        SELECT 1
        FROM TB_STATION
        WHERE STATION_ID = #{stationId}
        ) THEN 1 ELSE 0 END
        FROM DUAL
    </select>

    <!-- 충전소 정보 저장 -->
    <insert id="insertStation">
        INSERT INTO TB_STATION (
        station_id,
        station_name,
        station_operator_cd,
        station_lat,
        station_lon,
        station_address,
        station_address_d,
        station_area_code,
        station_phone,
        parking_id,
        created_date,
        created_id,
        updated_date,
        updated_id
        ) VALUES (
        #{station.stationId},
        #{station.stationName},
        #{station.stationOperatiorCD},
        #{station.stationLat, jdbcType=NUMERIC},
        #{station.stationLon, jdbcType=NUMERIC},
        #{station.stationAddress, jdbcType=VARCHAR},
        #{station.stationAddressD, jdbcType=VARCHAR},
        #{station.stationAreaCode, jdbcType=VARCHAR},
        #{station.stationPhone, jdbcType=VARCHAR},
        #{station.parkingId, jdbcType=NUMERIC},
        sysdate,
        #{userId, jdbcType=NUMERIC},
        sysdate,
        #{userId, jdbcType=NUMERIC}
        )
    </insert>


    <select id="findByParkingId" resultType="fs.human.ecospot.charger.vo.ChargerVO">
        SELECT
        PARKING_ID,
        PARKING_NAME,
        PARKING_TYPE,
        PARKING_ADDRESS,
        PARKING_ADDRESS_D,
        PARKING_OPERATING,
        PARKING_CAPACITY,
        PARKING_FEE,
        PARKING_PHONE
        FROM TB_PARKING
        WHERE PARKING_ID = #{parkingId}
    </select>

</mapper>